- hosts: localhost
  connection: local
  become: true

  tasks: 
  - name: Update system
    package:
      upgrade: true
      update_cache: true

  - name: Install base-devel for makepkg
    package:
      name:
        - base-devel
  
  - name: Ensure the ansible user exists
    user:
      name: ansible
      create_home: no
  
  - name: Allow the ansible user to run administrative tasks in passwordless sudo
    lineinfile:
      path: /etc/sudoers.d/u_ansible
      line: 'ansible ALL=(ALL) NOPASSWD: ALL'
      create: yes
      mode: 0644
      validate: 'visudo -cf %s'

  - name: Ensure the aurbuild user exists
    user:
      name: aurbuild
      create_home: yes

  - name: Allow the aurbuild user to run 'sudo pacman' without a password
    lineinfile:
      path: /etc/sudoers.d/u_aurbuild
      line: 'aurbuild ALL=(ALL) NOPASSWD: /usr/bin/pacman'
      create: yes
      mode: 0644
      validate: 'visudo -cf %s'

  - name: Install Paru
    kewlfft.aur.aur:
      name: paru-bin
      state: present
    become: yes
    become_user: aurbuild

  - name: Install ZFS
    kewlfft.aur.aur:
      name: zfs-dkms
      state: present
    become: yes
    become_user: aurbuild
  
  - name: Install packages
    package:
      name:
        - neovim
        - tmux
        - links
        - ranger
  
#  - name: Install zfs
#    kewlfft.aur.aur:
#      name: librewolf-bin
#      state: present
#    become: yes
#    become_user: aurbuild
  
#  - name: Install chezmoi
#    kewlfft.aur.aur:
#      name: chezmoi-git
#      state: present
#    become: yes
#    become_user: aurbuild
